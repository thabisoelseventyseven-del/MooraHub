@model List<MooraHub.Models.SupportTicket>
@{
    ViewData["Title"] = "Admin Inbox";
    string StatusLabel(string s) => s switch
    {
        "New" => "bg-danger",
        "InProgress" => "bg-warning text-dark",
        "Completed" => "bg-success",
        _ => "bg-secondary"
    };
}

<div class="container my-4">
    <div class="glass-card p-4 mb-4">
        <h2 class="tech-heading mb-1">Admin Inbox</h2>
        <p class="mb-0" style="opacity:.85;">Reply to user requests + manage status. (Admin only)</p>
    </div>

    @if (!Model.Any())
    {
        <div class="glass-card p-4">
            <p class="mb-0">No tickets yet.</p>
        </div>
    }
    else
    {
        <div class="d-grid gap-3">
            @foreach (var t in Model)
            {
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">Ticket #@t.Id — @t.UserEmail</div>
                        <div style="opacity:.75;">@t.CreatedAt.ToLocalTime()</div>
                    </div>

                    <hr style="opacity:.2;" />

                    <div class="mb-2"><strong>Services:</strong> @t.SelectedServices</div>
                    <div class="mb-2"><strong>Total:</strong> @($"R{t.TotalAmount}")</div>

                    <div class="mb-3">
                        <strong>Status:</strong>
                        <span class="badge @StatusLabel(t.Status)">@t.Status</span>

                        <form method="post" asp-controller="Inbox" asp-action="SetStatus" class="mt-2 d-flex gap-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@t.Id" />

                            <select class="form-select" name="status">
                                <option value="New" selected="@(t.Status == "New")">New</option>
                                <option value="InProgress" selected="@(t.Status == "InProgress")">In Progress</option>
                                <option value="Completed" selected="@(t.Status == "Completed")">Completed</option>
                            </select>

                            <button class="btn btn-outline-primary" type="submit">Update</button>
                        </form>
                    </div>

                    <div class="mb-2"><strong>User message:</strong></div>
                    <div class="p-3 rounded" style="background: rgba(0,0,0,0.06);">
                        @t.UserMessage
                    </div>

                    <div class="mt-3">
                        <strong>Reply:</strong>

                        <form method="post" asp-controller="Inbox" asp-action="Reply" class="mt-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@t.Id" />

                            <textarea class="form-control" name="adminReply" rows="3"
                              placeholder="Type your reply (Sepedi / English)..." required>@t.AdminReply</textarea>

                            <button class="btn btn-warning mt-2" type="submit">
                                Save Reply (marks unread for user)
                            </button>

                            @if (t.IsReplied)
                            {
                                <span class="ms-2" style="opacity:.75;">
                                    Last replied: @t.RepliedAt?.ToLocalTime()
                                </span>
                            }
                        </form>
                    </div>
                </div>
            }
        </div>
    }
</div>
